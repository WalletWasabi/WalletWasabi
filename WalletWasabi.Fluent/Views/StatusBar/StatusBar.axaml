<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:behaviors="clr-namespace:WalletWasabi.Fluent.Behaviors"
             xmlns:c="clr-namespace:WalletWasabi.Fluent.Controls"
             xmlns:statusBar="clr-namespace:WalletWasabi.Fluent.ViewModels.StatusBar"
             xmlns:converters="using:WalletWasabi.Fluent.Converters"
             xmlns:models="clr-namespace:WalletWasabi.Fluent.Models"
             xmlns:sb="clr-namespace:WalletWasabi.Fluent.Views.StatusBar"
             mc:Ignorable="d" d:DesignWidth="671" d:DesignHeight="32"
             x:DataType="statusBar:StatusBarViewModel"
             x:CompileBindings="True"
             x:Class="WalletWasabi.Fluent.Views.StatusBar.StatusBar">
  <UserControl.Styles>
    <Style Selector="PathIcon.rotate">
      <Style.Animations>
        <Animation Duration="0:0:2" IterationCount="Infinite">
          <KeyFrame Cue="0%">
            <Setter Property="(RotateTransform.Angle)" Value="0" />
          </KeyFrame>
          <KeyFrame Cue="100%">
            <Setter Property="(RotateTransform.Angle)" Value="-360" />
          </KeyFrame>
        </Animation>
      </Style.Animations>
    </Style>
    <Style Selector="FlyoutPresenter">
      <Setter Property="Background" Value="{DynamicResource SystemControlTransientBackgroundBrush}"/>
      <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Disabled"/>
      <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled"/>
    </Style>
  </UserControl.Styles>
  <Panel HorizontalAlignment="Right" VerticalAlignment="Bottom">
    <Interaction.Behaviors>
      <behaviors:ShowFlyoutOnPointerOverBehavior />
    </Interaction.Behaviors>
    <FlyoutBase.AttachedFlyout>
      <Flyout Placement="BottomEdgeAlignedRight" ShowMode="TransientWithDismissOnPointerMoveAway">
        <StackPanel TextBlock.Foreground="{DynamicResource TextControlForeground}"
                    TextBlock.FontSize="14"
                    MaxWidth="160"
                    ClipToBounds="False"
                    Spacing="16">

          <!-- Warning message TODO: use InfoMessage control-->
          <DockPanel
            IsVisible="{Binding CurrentState, Converter={x:Static converters:StatusBarStateVisibilityConverter.Instance}, ConverterParameter={x:Static models:StatusBarState.ConnectionIssueDetected}}">
            <PathIcon Data="{StaticResource info_regular}"
                      DockPanel.Dock="Top"
                      HorizontalAlignment="Center"
                      Height="30" />
            <TextBlock DockPanel.Dock="Bottom" Text="Wasabi was unable to connect to the server, some features may be unavailable, the reported balance could also be inaccurate. Retrying to connect." TextWrapping="Wrap"
                       TextAlignment="Center" />
          </DockPanel>

          <!-- Status -->
          <StackPanel Spacing="16">
            <c:StatusItem Icon="{StaticResource tor_icon}"
                          Title="Tor"
                          StatusText="{Binding TorStatus, Converter={x:Static converters:StatusConverters.TorStatusToString}}" />
            <c:StatusItem Icon="{StaticResource connector_regular}"
                          Title="Backend"
                          StatusText="{Binding BackendStatus, Converter={x:Static converters:StatusConverters.BackendStatusToString}}" />
            <c:StatusItem Icon="{StaticResource entities_regular}"
                          Title="Peers"
                          StatusText="{Binding Peers, Mode=OneWay, StringFormat={}{0} connected}" />
            <c:StatusItem Icon="{StaticResource btc_logo}"
                          Title="{Binding BitcoinCoreName}"
                          StatusText="{Binding BitcoinCoreStatus, Converter={x:Static converters:StatusConverters.RpcStatusStringConverter}}"
                          IsVisible="{Binding UseBitcoinCore}" />
          </StackPanel>

          <!-- Update -->
          <StackPanel Spacing="10">
            <StackPanel.IsVisible>
              <MultiBinding Converter="{x:Static BoolConverters.Or}">
                <Binding Path="UpdateAvailable" />
                <Binding Path="CriticalUpdateAvailable" />
              </MultiBinding>
            </StackPanel.IsVisible>

            <Separator Margin="-12 0 -12 6" />

            <c:StatusItem Icon="{StaticResource arrow_clockwise_regular}"
                          Title="Update available"
                          StatusText="{Binding VersionText}" />
            <Button Classes="activeHyperLink" Command="{Binding UpdateCommand}">
              <StackPanel Spacing="5" Orientation="Horizontal">
                <PathIcon Data="{StaticResource arrow_download_regular}" Height="13"/>
                <AccessText Text="Update now" />
              </StackPanel>
            </Button>

            <Button Classes="activeHyperLink" Command="{Binding AskMeLaterCommand}">
              <StackPanel Spacing="5" Orientation="Horizontal">
                <PathIcon Data="{StaticResource clock_regular}" Height="13"/>
                <AccessText Text="Ask me later" />
              </StackPanel>
            </Button>
          </StackPanel>
        </StackPanel>
      </Flyout>
    </FlyoutBase.AttachedFlyout>

    <Panel.Styles>

      <Style Selector="DockPanel > TextBlock">
        <Setter Property="VerticalAlignment" Value="Center" />
        <Setter Property="TextTrimming" Value="CharacterEllipsis" />
        <Setter Property="Margin" Value="5" />
        <Setter Property="FontSize" Value="14" />
      </Style>

      <Style Selector="DockPanel > PathIcon">
        <Setter Property="Height" Value="30" />
        <Setter Property="Margin" Value="5" />
        <Setter Property="(DockPanel.Dock)" Value="Right" />
        <Setter Property="VerticalAlignment" Value="Center" />
      </Style>

    </Panel.Styles>

     <!--Update available--> 
    <DockPanel IsVisible="{Binding CurrentState, Converter={x:Static converters:StatusBarStateVisibilityConverter.Instance}, ConverterParameter={x:Static models:StatusBarState.UpdateAvailable}}">
      <PathIcon Data="{StaticResource arrow_clockwise_with_elipse}"
                Foreground="Goldenrod" />
      <TextBlock Text="Update available" Foreground="Goldenrod" />
    </DockPanel>

     <!--Critical update available--> 
    <DockPanel
      IsVisible="{Binding CurrentState, Converter={x:Static converters:StatusBarStateVisibilityConverter.Instance}, ConverterParameter={x:Static models:StatusBarState.CriticalUpdateAvailable}}">

      <PathIcon Data="{StaticResource critical_update}"
                Foreground="{DynamicResource SystemErrorTextColor}" />
      <TextBlock Text="Critical update available" Foreground="IndianRed" />
      
    </DockPanel>

    <!-- Ready -->
    <PathIcon Data="{StaticResource checkmark_circle_filled}"
              Foreground="{Binding $parent[sb:StatusBar].Foreground}"
              VerticalAlignment="Center" HorizontalAlignment="Right"
              Height="40"
              Margin="10 0"
              IsVisible="{Binding CurrentState, Converter={x:Static converters:StatusBarStateVisibilityConverter.Instance}, ConverterParameter={x:Static models:StatusBarState.Ready}}" />

    <!-- Connection issue -->
    <PathIcon Data="{StaticResource warning_filled}"
              Foreground="Gold"
              VerticalAlignment="Center" HorizontalAlignment="Right"
              Height="30"
              Margin="10 0"
              IsVisible="{Binding CurrentState, Converter={x:Static converters:StatusBarStateVisibilityConverter.Instance}, ConverterParameter={x:Static models:StatusBarState.ConnectionIssueDetected}}" />

    <!-- Loading -->
    <PathIcon Data="{StaticResource arrow_sync_regular}"
              Foreground="{Binding $parent[sb:StatusBar].Foreground}"
              VerticalAlignment="Center" HorizontalAlignment="Right"
              Height="40"
              Margin="10 0"
              IsVisible="{Binding CurrentState, Converter={x:Static converters:StatusBarStateVisibilityConverter.Instance}, ConverterParameter={x:Static models:StatusBarState.Loading}}"
              Classes.rotate="{Binding $self.IsVisible}" />

  </Panel>
</UserControl>
